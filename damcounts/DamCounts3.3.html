<html>
<head>
    <title>Columbia Basin Dam Counts</title>

    <meta charset="UTF-8">
	
	<link rel="stylesheet" type="text/css" href="/script/dc.js/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/script/dc.js/dc.css"/>
	<script src="/script/jquery-1.12.2.min.js"></script>
	<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>	
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	<style>
hr{
    border: 0;
    height: 1px;
    background: #333;
    background-image: linear-gradient(to right, #ccc, #333, #ccc);
}		
.showdata{
	stroke: #016986;
}	
#help{
	width: 1150px;
}	
#about{
	width: 1150px;
}
.esu_block{
	background-color: #33b4ff;
}	
.mpg_block1{
	background-color: #f2f2f2;
}
.mpg_block2{
	background-color: #e6e6e6;
}	
select{
	width: auto;
}
	
.sized{
	width: 600px;
	overflow: scroll;
}
#dataview{
	height: 100px;
	width: 400px;
	overflow: auto;
	margin-left: 50px;
	margin-bottom: 100px;
}
#esu_label{
	text-align: center;
	font: 12px sans-serif;
}	
.poplabel{
	margin-left: 20px;
	margin-right: 20px;
	text-align: center;
	font-weight: bold;
}
#metaheader{
	height: 80px;
}	
#metamap{
	height: 500px;
	top: 525px;
	position: relative;
}


#cfilters{
	position: relative;
}

#metafooter{
	position: relative;
	top: 410px;
}
	
.area {
  fill: url(#temperature-gradient);
}

.overlay {
  fill: none;
  pointer-events: all;
}

.curse line {
  fill: none;
  stroke: black;
  stroke-width: 1px
}

.curse text, line {
	opacity: 0.5;
}

.line2 {
  stroke: black;
  stroke-width: 4px;
  fill: black;
}
	.control {margin:5px;}
	#spawn{
	  overflow: hidden;
	}
	#hatch{
	  overflow: hidden;
	}	
	#agec{
	  overflow: hidden;
	}
	#meta{
	  overflow: hidden;
	}	
	#divmap {
      width:500px;
      height:400px;
	  background-image: url(river_background.jpg);
    }
	#filters {
		border-right-style: solid;
		border-width: 2px;
		border-color: #cccccc;
	}
	
	g.tick text{
		cursor: pointer;
	}
	
	g.z {
		font-size: 11px;
	}
	
	.map {
      width:600px;
      height:400px;
    }
	
	#obsmap {
		height: 600px;
		width: 800px;
	}
	
	#datarow {
		height: 300px;
		overflow: scroll;
	}
	.river path{
				fill: none;
				stroke: #0570b0;
				stroke-width: 2;
			}
	.borders path{
				fill: none;
				stroke: black;
			}
	#spinner * { 
		filter: none; 
		-moz-opacity: 100%; 
		position: absolute;
		top: 200px;
		left: 650px;
		}
		
div.tooltip {   
  position: absolute;           
  text-align: left;                            
  padding: 2px;             
  font: 16px sans-serif;        
  background: #ccc;   
  border: 0px;      
  border-radius: 8px;           
  pointer-events: none;         
}
svg	{ overflow: hidden; }
	
	table {
	margin: 10px;
	padding-top: 2px;
    padding-right: 10px;
    padding-bottom: 2px;
    padding-left: 10px;
	}
	
.dc-table-label {
font-weight: bold;
}

.header th {
text-align: center;	
}

.span14{
	margin-top: 25px;
}

.tiptable {
	font: 12px sans-serif;
}

.axis path, .axis line {
    fill: none;
    shape-rendering: crispedges;
    stroke: #000000;
}
.grid .tick {
    stroke: grey;
    opacity: 0.5 !important;
}
.bar rect {
        fill: #ed1e79;
    }

    .bar text.value {
        fill: black;
    }
    circle {
    fill: none;
    stroke: black; 
    stroke-width: 1;
}

.legend text{
	font: 12px sans-serif;
}

.checkbox-dropdown {

    width: 150px;
    border: 1px solid silver;
    cursor: pointer; /* use correct mouse pointer when hovering over the dropdown */
    padding: 1px;
    position: relative;
    margin: 0 auto;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Display CSS arrow to the right of the dropdown text */
.checkbox-dropdown:after {
    content:'';
    height: 0;
    position: relative;
    width: 0;
    border: 6px solid transparent;
    border-top-color: #000;
    top: 0px;
    right: 0px;

    content: "";
    width: 0;
    height: 0;
    position: absolute;
    right: -15px;
    top: 50%;
    margin-top: -6px;
    border-width: 6px 0 6px 6px;
    border-style: solid;
    border: 6px solid transparent;
    border-top-color: #000; 	
}

/* Reverse the CSS arrow when the dropdown is active */
.checkbox-dropdown.is-active:after {
    border-bottom-color: #000;
    border-top-color: #fff;
    margin-top: -9px;
}

.checkbox-dropdown-list {
	width: 150px;
	background-color: aliceblue;
    list-style: none;
    margin: 0;
    padding: 0;
    position: absolute;
    top: 100%; /* align the dropdown right below the dropdown text */
    border: inherit;
    border-top: none;
    left: -1px; /* align the dropdown to the left */
    right: -1px; /* align the dropdown to the right */
    opacity: 0; /* hide the dropdown */
    -webkit-transition: opacity 0.1s ease-in-out;
    -moz-transition: opacity 0.1s ease-in-out;
    -o-transition: opacity 0.1s ease-in-out;
    -ms-transition: opacity 0.1s ease-in-out;
    transition: opacity 0.1s ease-in-out;
    pointer-events: none; /* avoid mouse click events inside the dropdown */
}
.is-active .checkbox-dropdown-list {
    opacity: 1; /* display the dropdown */
    pointer-events: auto; /* make sure that the user still can select checkboxes */
}

.checkbox-dropdown-list li label {
    display: block;
	margin-top: 5px;
    border-bottom: 1px solid silver;
    padding: 0px;
    -webkit-transition: all 0.2s ease-out;
    -moz-transition: all 0.2s ease-out;
    -o-transition: all 0.2s ease-out;
    -ms-transition: all 0.2s ease-out;
    transition: all 0.2s ease-out;
}

.checkbox-dropdown-list li label:hover {

}

li{
	margin-left: 5px;
}

.mpg_block{
	background-color: "gray";
}
	</style>

	
</head>
<body>
<div class="container-fluid">
<div class="row">
<div class="span8">
<h2>Columbia Basin Dam Counts</h2>
</div>
<div class="span8">
<!--
	Cumulative Reference: <select id="cum_reference" onchange="toggleCumRef(this)">
	<option value="ytd10yr">YTD 10yr Mean</option>
	<option value="ytd4yr">YTD 4yr Mean</option>
	<option value="ytd2016">YTD 2016</option>
	<option value="total10yr">Full 10yr Mean</option>
	</select>
-->	
	<div class="checkbox-dropdown dropdown_text">Plot Options
	<ul class="checkbox-dropdown-list"><li><b>Year Detail:</b></li>
		<li>
          <label>
			<input class="daily_scale_global" type="checkbox" onchange="params.daily.scale_global=this.checked; setChecked(this);"/>&nbsp;Global Scaling</label></li>	
			<li><b>Dam Detail:</b></li>
			<li>
                <label>
					<input type="radio" name="dam_geomeans" onchange="params.dam_geomean = 'none';"/>&nbsp;No Mean</label></li>	
            <li>
                <label>
					<input type="radio" name="dam_geomeans" onchange="params.dam_geomean = '5yrGeomean';" checked/>&nbsp;5yr geomean</label></li>						
            <li>
                <label>
					<input type="radio" name="dam_geomeans" onchange="params.dam_geomean = '10yrGeomean';"/>&nbsp;10yr geomean</label></li>	
            
		<li><b>Value Display:</b></li>   
			<li>
                <label>
					<input type="radio" name="disp_curr_value" onchange="params.current_value_display=0; plotAll()" checked/>&nbsp;YTD</label></li>	
            <li>
                <label>
					<input type="radio" name="disp_curr_value" onchange="params.current_value_display=1; plotAll()"/>&nbsp;YTD (YTD 10yrAvg)</label></li>						
            <li>
                <label>
					<input type="radio" name="disp_curr_value" onchange="params.current_value_display=2; plotAll()" checked/>&nbsp;YTD (% 10yrAvg)</label></li>	
            <li>
                <label>
					<input type="radio" name="disp_curr_value" onchange="params.current_value_display=3; plotAll()"/>&nbsp;% 10yrAvg</label></li>					
            <li>
                <label>
					<input type="radio" name="disp_curr_value" onchange="params.current_value_display=4; plotAll()"/>&nbsp;None</label></li>
					</ul>
    </div>
</div>
</div>

<div class="row">
<div class="span16" id="filters">
  <ul class="nav nav-tabs">
    <li class="active"><a data-toggle="tab" href="#chinook">Chinook</a></li>
	<li><a data-toggle="tab" href="#jchinook">Chinook Jacks</a></li>
    <li><a data-toggle="tab" href="#steelhead">Steelhead</a></li>
	<li><a data-toggle="tab" href="#wsteelhead">Wild Steelhead</a></li>
	<li><a data-toggle="tab" href="#sockeye">Sockeye</a></li>
	<li><a data-toggle="tab" href="#coho">Coho</a></li>
	<li><a data-toggle="tab" href="#jcoho">Coho Jacks</a></li>
	<li><a data-toggle="tab" href="#lamprey">Lamprey</a></li>
	<li><a data-toggle="tab" href="#shad">Shad</a></li>
	<li><a data-toggle="tab" href="#about">About</a></li>
	<li><a data-toggle="tab" href="#help">Help</a></li>
  </ul>

<div class="tab-content">

    <div id="chinook" class="tab-pane fade in active">
	<div id="chinook_svg" class="control"></div>
	<div id="Chin_legend" class="control"></div>
	<div id="Chin_svg" class="control"></div>
	</div>
	
    <div id="jchinook" class="tab-pane fade">
	<div id="jchinook_svg" class="control"></div>
	<div id="JChin_legend" class="control"></div>
	<div id="JChin_svg" class="control"></div>
	</div>
 
    <div id="steelhead" class="tab-pane fade">
	<div id="steelhead_svg" class="control"></div>
	<div id="Stlhd_legend" class="control"></div>
	<div id="Stlhd_svg" class="control"></div>
	</div>
	
	<div id="wsteelhead" class="tab-pane fade">
	<div id="wsteelhead_svg" class="control"></div>
	<div id="WStlhd_legend" class="control"></div>
	<div id="WStlhd_svg" class="control"></div>
	</div>
	
	<div id="sockeye" class="tab-pane fade">
	<div id="sockeye_svg" class="control"></div>
	<div id="Sock_legend" class="control"></div>
	<div id="Sock_svg" class="control"></div>
	</div>
	
	<div id="coho" class="tab-pane fade">
	<div id="coho_svg" class="control"></div>
	<div id="Coho_legend" class="control"></div>
	<div id="Coho_svg" class="control"></div>
	</div>

	<div id="jcoho" class="tab-pane fade">
	<div id="jcoho_svg" class="control"></div>
	<div id="JCoho_legend" class="control"></div>
	<div id="JCoho_svg" class="control"></div>
	</div>

	<div id="lamprey" class="tab-pane fade">
	<div id="lamprey_svg" class="control"></div>
	<div id="Lmpry_legend" class="control"></div>
	<div id="Lmpry_svg" class="control"></div>
	</div>

	<div id="shad" class="tab-pane fade">
	<div id="shad_svg" class="control"></div>
	<div id="Shad_legend" class="control"></div>
	<div id="Shad_svg" class="control"></div>
	</div>	

	<div id="about" class="tab-pane fade">
	<div id="about-tab" class="control">
		<p>
		<b>Source:</b><br/>Data taken from the <a href="http://www.cbr.washington.edu/" target=_new">DART Adult Passage Dataset</a> on 1/4/2019, as are the following notes:
		</p>
		<p class="small bold">Notes on the DART Adult Passage Dataset</p>
		<p><b>USACE Dams Video and Live Counting:</b>
		From November through March, video tape fish counting occurs at US Army Corps of Engineers dams with fish ladders on the Columbia and Snake Rivers.  Fish counting by video tape takes at least a few days to process: the fish counters have to make, collect, and read the tapes, and then submit their fish counts. DART retrieves and posts the data as soon as it is made available. On April 1, live fish counting resumes at all 8 Columbia River and Snake River Corps dams with fish ladders: from April through October each year for 16 hours each day, fish counters working at each fish ladder look directly into the fish ladders to count the fish passing by. 
		</p>

		<p><b>Bonneville, The Dalles, John Day, McNary, Ice Harbor, Lower Monumental, Little Goose, and Lower Granite</b>: On March 10, 2011, DART's Adult Passage data from the Army Corps dams--Bonneville, The Dalles, John Day, McNary, Ice Harbor, Lower Monumental, Little Goose, and Lower Granite--were updated in their entirety (1938-2011) to reflect the numbers currently reported by the US Army Corps Portland District. The updates included replacement of manually entered data from printed reports, the inclusion of historical data previously missing from DART, and the correction of counts that have been updated.
		</p>

		<p><b>Willamette Falls Video Counting</b>: Fish counting through Willamette Falls fishway occurs at the main viewing window. Video cameras and time lapsed video recorders are used to record fish passage 24 hrs/day, 365 days/year. The ODFW schedule for reviewing the tapes is Monday through Friday. It takes most of the day to accurately review one day of fish passage on tape when the counts are high. 
		</p>

		<p><b>Individual Status Reports</b></p>
		<div class="mindent">

		<p><b>Bonneville Dam</b>: Lamprey is the combined count from the fish counting windows at Bonneville, reported daily. LPS is the count from the Lamprey Passage Systems (LPS) at Bonneville. The fish counting windows and LPS are mutually exclusive. LPS are located at Bradford Island, Washington Shore and Cascades Island. LPS were opened in 2009 and counting started in June 2010. NOAA's LPS lamprey counts at Bonneville for 2011 are not available to the public until motion trigger images and data logger tallies can be compared to resolve the status of lamprey passage during data gaps and anomalous data series. This comparison is expected during the winter of 2011-12.
		</p>

		<p><b>Rocky Reach Dam, June 8-9, 2005</b>: Video was lost at Rocky Reach Dam from 1751 hours on 8 June and was not returned to operation until 0729 hours on 9 June. As a result, the adult passage counts at Rocky Reach Dam are incomplete for both days.
		</p>

		<p><b>Tumwater Dam</b>: Some video counts between 8/22/2011 9:19am to 9/05/2011 9:36am and between 9/23/2011 11:28am to 10/19/2011 7:52pm were not recorded, so passage counts during this period remain incomplete. Spring Chinook daily counts from 8/1/2011 - 9/15/2011 were adjusted to reflect know fallbacks from PIT tag analysis (M.Hughes, pers. com.). 
		<br/>
		Missing video counts: 7/27/12-7/30/12, 12/05/12-12/07/12, 12/17/12-12/21/12, and 12/29/12-01/01/13. Passage counts during these periods remain incomplete. Estimated sockeye passage during 2012: 66,520 fish. This run escapement includes an estimate for the number of sockeye that passed Tumwater during periods of missing video. Contact Travis Maitland for additional information pertaining to sockeye run escapement (WDFW, Wenatchee District Office, 509-665-3337).
		</p>

		<p><b>Wanapum Dam, 2014</b>:There were no adult passage fish counts at Wanapum Dam in 2014 due to a fracture discovered on the spillway in February 2014. The Reservoir elevation was lowered to reduce stress on the structure. The lowered reservoir made the regular fish ladder facilities and counting equipment inoperable. GCPUD was able to make modifications for fish passage at the dam, but a count was not taken at the dam.
		</p>

		<p><b>Wells Dam, Lamprey Research, 2007-2008</b>: The <b>Lamprey</b> adult passage counts at Wells Dam are not reflective of actual run size during 2007-2008. Trapping, monitoring, and research efforts at Wells Dam artificially lowered the passage numbers for Lamprey; i.e., more fish would have passed without tagging and trapping efforts. 
		</p>

		<p><b>Willamette Falls</b>: The Willamette Falls fish ladder was not operational on the following dates: 11/29/2005-12/1/2005, 12/6/2005-12/8/2005, 12/13/2005-12/14/2005, 8/26/2008-9/21/2008, 8/23/2010-8/27/2010. 
		</p>

		<p><b>Zosel Dam</b></p>
		<p>
		<div><u>Zosel Dam 2011 - 2013 data notes.</u></div>
		<div>The Zosel Dam spillway gates were opened to allow for spring runoff during the periods of</div>
		<dl>
		<dd>May 7, 2011 through August 7; 2011;</dd>
		<dd>April 26, 2012 through August 9, 2012;</dd>
		<dd>and May 4, 2013 through July 20, 2013;</dd>
		</dl>
		<div>during which, an unknown number of salmonids may have passed through the spillway undetected by the video system.</div>
		</p>
		<p>
		<div><u>Zosel Dam 2010 data notes.</u></div>
		<ol>
		<li>Equipment failure resulted in a loss of data from the right bank ladder (half of the sampling area at Zosel Dam, WA) August 25th through October 31.</li>
		<li>Linear regression was used to estimate the missed number of sockeye passing through the right bank ladder during the time data were lost (see Miller, BM, JL Panther, and JA Arterburn. 2010. 2010 Annual Report. Confederated Tribes of the Colville Indian Reservation, Omak, WA. located at <a href="http://www.cctobmep.com/media/files/2010_OBMEP_Annual_Report.pdf" class="popup" target="new">http://www.cctobmep.com/media/files/2010_OBMEP_Annual_Report.pdf</a>)</li>
		<li>No steelhead were observed in the left bank ladder during the time of equipment failure; therefore, no estimated number of missed steelhead were generated.  Steelhead do not typically pass Zosel Dam during the time equipment failed.</li>
		<li>A relatively small number of Chinook were observed during the time of equipment failure, and it was not possible to use linear regression analysis to predict missed numbers of fish. Using the proportion of sockeye passing on the left versus the right bank ladders, potentially 127 Chinook passed the right bank ladder during the time equipment failed. However, there is no certainty associated with this number, therefore this estimate was not included in the total number of Chinook reported for 2010. </li>
		</ol>
		</p>
		<p>
		<div><u>Zosel Dam 2008 data notes.</u></div>
		<div>Zosel Dam estimated 2008 adult sockeye passage counts missed due to equipment malfunction.</div>
		<dl><dd>15 May 12:00 - 20 May 12:00 = 0</dd>
		<dd>17 Jul 00:00 - 18 Jul 19:00 = 6678</dd>
		<dd>09 Aug 10:00 - 12 Aug 12:00 = 649</dd>
		<dd>31 Aug 00:00 - 04 Sep 10:00 = 570</dd>
		<dd>Total Missed Sockeye count = 7897</dd>
		<dd>Initial 2008 Sockeye count = 77533</dd>
		<dd>Revised 2008 Sockeye count = 85430</dd>
		<dd>At this time, missed sockeye counts are not reflected in query results.</dd> 
		</dl>
		</p>

		</div>
		<p><b>USACE Data Disclaimer</b>: These data are furnished with the understanding that the Corps of Engineers makes no warranties concerning the accuracy, reliability, or suitability of the data for any particular purpose.
		</p>
		<p>
		<b>Yakima Klickitat Fisheries Project Data:</b> Historical daily counts for Roza Dam for the years 1940-1967 and 1982-1985 were obtained and loaded from data provided courtesy of the U.S. Bureau of Reclamation's Yakima office. In years where daily counts are not available, the Yakama Nation has provided weekly counts with data assigned to an arbitrary day in the week for which counts are available. This is the case for Prosser Dam for the years 1983-1991 and for Roza Dam for the years 1986-1990. 
		<br/>[Text from the Yakima Klickitat Fisheries Project web page, <a href="http://ykfp.org/adultcounts.htm" class="external">http://ykfp.org/adultcounts.htm</a>.]
		</p>

		<p><b>Tumwater Dam</b>: Adult passage data for Tumwater Dam is the combination of released counts, referring to fish passed upstream of the dam and allowed to spawn naturally, and collected counts, referring to fish retained for hatchery broodstock. The <b>Chinook</b> adult passage counts are the sum of hatchery spring, hatchery summer, wild spring, and wild summer chinook as reported by WDFW and Chelan PUD. The <b>Jack Chinook</b> adult passage counts are the sum of hatchery spring, hatchery summer, wild spring, and wild summer jack chinook as reported by WDFW and Chelan PUD.
		</p>
		<p>
		<a id="stlhd"> </a>
		<b>Steelhead Counts</b>: The <b>Steelhead</b> parameter includes both hatchery and wild counts. Prior to 1995 wild steelhead data was not published on a daily basis. The <b>Steelhead-Wild</b> parameter is a subset of the total steelhead and may include unmarked hatchery fish.
		</p>
		<p>
		<b>Contact</b><br>
		This Tool is still in development and we welcome your feedback. Please send comments to:<br><a href="mailto://brianm@salmonetics.com">Brian Maschhoff</a> or <a href="mailto://rich@hinrichsenenvironmental.com">Rich Hinrichsen</a>.
		</p>
		<p>Support for development was provided by the Bonneville Power Administration.
		<br/>
		<img src="logos.jpg" usemap="#logomap">

		<map name="logomap">
			<area shape="rect" coords="0,0,118,100" href="http://www.bpa.gov" alt="Bonneville Power Administration" target="_new">
			<area shape="rect" coords="119,0,275,100" href="http://www.salmonetics.com" alt="Salmonetics" target="_new">
			<area shape="rect" coords="275,0,434,100" href="http://www.hinrichsenenvironmental.com" alt="Hinrichsen Environmental" target="_new">
		</map>
		</p>
	</div>
	</div>	
	<div id="help" class="tab-pane fade">
	<div id="help-tab" class="control">
	<h4>Overview</h4>
		<!--
		<iframe src="//www.slideshare.net/slideshow/embed_code/key/aoeehoL8a0W9ZT" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/secret/aoeehoL8a0W9ZT" title="Dam count overview" target="_blank">Dam count overview</a> </strong> from <strong><a href="https://www.slideshare.net/BrianMaschhoff" target="_blank">Brian Maschhoff</a></strong> </div>
		-->
		<iframe src="https://docs.google.com/presentation/d/e/2PACX-1vRThREOxFdR74uFuBUC7uzFdu68dI-2A-3-oCIANWjXyWGuuxISwbQKi3ytXlpRZUaZ14lFiNih-jU9/embed?start=false&loop=false&delayms=10000" frameborder="0" width="1100" height="650" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>
		<p>
		<b>Browser Requirements</b>
		<ol>
			<li>A reasonably recent browser (Chrome, IE, Firefox, Opera, Safari)</li>
			<li>At least 1280 horizontal pixels in browser window. Decrease magnification if necessary</li>
		</ol>
		
		</p>	


	</div>
	</div>	
	
</div>  

</div>
</div>


</div> <!--end container-->
<div id="spinner"><img src="/images/spinner.gif"></div>
</body>

<script>


var format1 = d3.time.format("%Y-%m-%d");

var Current;
var Default;

var tipdiv = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

var counts = {};
var scale_by_dam = true;

var params = {daily: 
	{	 max_counts: {},
		 max_cum: {}, 
		 scale_global: false, 
		 id: 0,
		 csvdata: {},
	 },
	 cum_ref: "ytd10yr",
	 dam_geomean: "5yrGeomean"
	 };

	params.current_value_display=2; 
	 
params.topchart = {width: 1050,height: 650,
		margin: {
			top: 0, right: 275, bottom: 50, left: 125, left2: 25, right2: 75
		}
}

	 
var projects = ["Willamette Falls","Bonneville","The Dalles","John Day","McNary","Ice Harbor","Lower Monumental","Little Goose","Lower Granite","Prosser","Roza","Priest Rapids","Wanapum","Rock Island","Tumwater","Rocky Reach","Wells","Zosel"];
projects.reverse();
var species = ["Chinook","Jack.Chinook","Steelhead","Wild.Steelhead","Sockeye","Coho","Jack.Coho","Shad","Lamprey"];

var species_lookup = {"Chinook": "Chin", "Jack.Chinook": "JChin", "Steelhead": "Stlhd", "Wild.Steelhead": "WStlhd","Sockeye": "Sock", "Coho": "Coho", "Jack.Coho": "JCoho", "Shad": "Shad", "Lamprey": "Lmpry"};

var project_lookup = {"BON": "Bonneville","IHR": "Ice Harbor","JDA": "John Day","LGS": "Little Goose","LWG": "Lower Granite","LMN": "Lower Monumental","MCN": "McNary","PRD": "Priest Rapids","PRO": "Prosser","ROZ": "Roza","RIS": "Rock Island","RRH": "Rocky Reach","TDA": "The Dalles","TUM": "Tumwater","WAN": "Wanapum","WEL": "Wells","WFF": "Willamette Falls","ZOS": "Zosel"};

var rlookup = function(obj){
	var keys = Object.keys(obj);
	var obj2 = {};
	keys.forEach(function (d) {
		obj2[obj[d]] = d;
	});
	return obj2;
}

var rspecies_lookup = rlookup(species_lookup);
var rproject_lookup = rlookup(project_lookup);

species.forEach(function(d){
	counts[d] = [];
	params.daily.max_counts[d] = 0;
	params.daily.max_cum[d] = 0;
});

var setChecked = function(obj){
d3.selectAll("." + d3.select(obj).attr("class")).property("checked",obj.checked);
}

var _width = 1000, _height = 650;
var width, height;

		
var xmaxes = [2.5,5];

var mycolours =["#D92121","#21D921", "#ffff00", "#ff8000"]


var tipdiv = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

var addScale = function(s,x1,y1,max,height,int_only){
var r;
    var y = d3.scale.linear().domain([max,0]).range([0,height]); // value -> display
    if(int_only)r = d3.svg.axis().scale(y).orient("right").ticks(4).tickFormat(d3.format("d"));
	else r = d3.svg.axis().scale(y).orient("right").ticks(4).tickFormat(d3.format(".2f"));
	var g = s.append("g")
		.attr("transform", "translate(" + x1 + "," + y1 + ")")
		.attr("height",height)
		.append("g")
		.attr("class", "z axis")
		.call(r)
		.append("text")
		.attr("transform", "rotate(-90)");
		
}

d3.hsl("hsl(0, 76%, 50%)")

var getTempColor = function(d){
	var thermal = ["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"];
	
	var hsl;
	if(d < 19){
		hsl = 180 + Math.round((20-d)*3);	
	}
	else if(d<20){
		hsl = 45 + Math.round((20-d)*100);
	}	
	else{
		hsl = 45 - Math.round((d-20)*12);
	}
	return d3.hsl("hsl(" + hsl + ", 76%, 50%)")
}

function clone(obj) {
    if (null == obj || "object" != typeof obj) return obj;
    var copy = obj.constructor();
    for (var attr in obj) {
        if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
    }
    return copy;
}

var toggleCumRef = function(obj){
params.cum_ref=obj.options[obj.selectedIndex].value;

}

var plotDailyCounts = function(data,fdata,target,label,id){
	
	var height2 = 175;
	var width2 = 1050;
	var margin = {top: 20, right: 100, bottom: 50, left: 150},
	width = width2 - margin.left - margin.right,
	height = height2 - margin.top - margin.bottom;
	
	var species = data[0].Species;
	var project = data[0].Project;
	var year = data[0].Date.getFullYear();
	
	params.daily.csvdata[id][species] = []
	
	var flowdata = {}
	
	fdata.forEach(function(d){
		flowdata[params.formatDate(d.Date)]=d;
	})
	
	var svg1 = d3.select(target).append("svg")
		.attr("class","daily")
		.classed(id,true)
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom);
		
	var max_counts = 0;
	
	var bar_scale = height/(projects.length+1)*.9;
	var bar_scale2 = height/(projects.length+1);

	var temps = [], mdata = [];
	
	data.sort(function(a,b){
		return a.Date-b.Date;
	});	
	var sum = 0;
	var asum = 0;
	data.forEach(function(d){
		sum = sum + d.Counts;
		asum = asum + d.Avg;
		d.cum = sum;
		d.acum = asum;
		max_counts = d.Counts > max_counts ? d.Counts : max_counts;
		if(d.Avg > 0){
			mdata.push({Avg: d.Avg, Date: d.Date});
			max_counts = d.Avg > max_counts ? d.Avg : max_counts;
		}
		var date = params.formatDate(d.Date)
		if(!flowdata[date])flowdata[date] = {};
		flowdata[date].Count = d.Counts;
		flowdata[date].Avg = d.Avg;
		flowdata[date].YTD = d.cum;
		flowdata[date].AvgYTD = d.acum;
		//if(d.TempC != "" & (+d.TempC)>0)temps.push({Date: d.Date, Temp: +d.TempC});
	});
	params.daily.max_counts[species] = max_counts > params.daily.max_counts[species] ? max_counts : params.daily.max_counts[species];
	if(asum>sum)sum=asum;
	params.daily.max_cum[species] = sum > params.daily.max_cum[species] ? sum : params.daily.max_cum[species];
	//console.log(species)
	//console.log(params.daily.max_counts[species])
	if(params.daily.scale_global){
		max_counts=params.daily.max_counts[species];
		sum = params.daily.max_cum[species];
	}
	var min_date = d3.time.format("%Y-%m-%d").parse(year + "-01-01");
	var max_date = d3.time.format("%Y-%m-%d").parse(year + "-12-31");
	
	var x = d3.time.scale().domain([min_date,max_date]).range([0, width]),
		y = d3.scale.linear().domain([max_counts,0]).range([0, height]),
		y1 = d3.scale.linear().domain([sum,0]).range([0, height]);

	var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.time.format("%b-%d"));;
	var yAxis = d3.svg.axis().scale(y).orient("left").ticks(4);
	var yAxis1 = d3.svg.axis().scale(y1).orient("right").ticks(4);

	var svg2 = svg1.append("g")
			.attr("class", "main")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");		
			
	svg2.append("g")
			.attr("class", "y axis")
			.call(yAxis)
			.append("text")
			.attr("transform", "rotate(-90)")
			.attr("y", 6)
			.attr("dy", ".71em")
			.style("text-anchor", "end");

	svg2.append("g")
			.attr("class", "y1 axis")
			.attr("transform", "translate(" + width + "," + 0 + ")")
			.call(yAxis1);
			
	svg2.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);
		
	var cumLine = d3.svg.line()
	.x(function(d) { return x(d.Date); })
	.y(function(d) { return y1(d.cum); })
	.interpolate("step-after");

	var acumLine = d3.svg.line()
	.x(function(d) { return x(d.Date); })
	.y(function(d) { return y1(d.acum); })
	.interpolate("step-after");	

	var meanLine = d3.svg.line()
	.x(function(d) { return x(d.Date); })
	.y(function(d) { return y(d.Avg); })
	.interpolate("step-after");	

	var abars = svg2.append("g").attr("class", "abars");
	var mbars = svg2.append("g").attr("class", "mbars");
	
	var bwidth = Math.round(width/400);	
	var bwidth2 = Math.round(width/365);
	abars.selectAll("rect")
      .data(data)
	  .enter()
	  .append("rect")
      .attr("width", bwidth)
	  .attr("x", function(d) { 
		var _x = x(d.Date) - bwidth/2;
		return(_x);
		})
      .attr("y", function(d) {
		var yy = d.Counts > 0 ? y(d.Counts) : height; 
		return yy;
	  })
      .attr("height", function(d) {
		var h= d.Counts > 0 ? height-y(d.Counts) : 0; 
		return h; })
	  .style("fill", function(d) {
			
			return "#016986";
	  })
	  .style("stroke","#999999");
	   

	var mline = svg2.append("g").attr("class", "meanline");
	var cline = svg2.append("g").attr("class", "cumline");
	var acline = svg2.append("g").attr("class", "acumline");
	
	mline.append("path")
		.attr("class", "mean")
		.attr("d", function (d) {
			return meanLine(data);
		})
		.style("stroke-width", 1)
		.style("fill","none")	
		.style("stroke","green")	
	
	cline.append("path")
		.attr("class", "cum")
		.attr("d", function (d) {
			return cumLine(data);
		})
		.style("stroke-width", 1)
		.style("fill","none")	
		.style("stroke","black")

	acline.append("path")
		.attr("class", "acum")
		.attr("d", function (d) {
			return acumLine(data);
		})
		.style("stroke-width", 1)
		.style("fill","none")	
		.style("stroke","green")		

	svg2.append('text')
	.attr('x', 10)
	.attr('y', height-10)
	.text(label + " " + year);
	
	var drawCursor = function(target,date){
		d3.selectAll(".curse").remove();  
		curse = target.append("g")
		.attr("class","curse")
		.style("z-index", -1)
		// vertical crosshair
		curse.append("line")
          .attr({
            "x1": x(date),
            "y1": 0,
            "x2": x(date),
            "y2": height + margin.bottom,
			"stroke-width":1,
			"stroke":"black"			  
            })
	}	
	
	//overlays for mouseover
	var mouseOverHTML = function(d){
		var fdata = flowdata[params.formatDate(d.Date)]
		if(!fdata)fdata = {Flow: "NA", Mflow: "NA"};
		var formatDecimal = d3.format(".1f");
		var Temp = "NA";
		if(!isNaN(fdata.TempC)) Temp = fdata.TempC + "C";
		else if(!isNaN(fdata.TempS))Temp = fdata.TempS + "C";
		
		return '<table width="200" cellpadding="3"><tr><th align="right">Date</th><td align="left">'+ params.formatDate(d.Date) + '</td></tr><tr><th align="right">Count</th><td align="left">' + d.Counts + ' (' + formatDecimal(100*d.Counts/d.Avg) + '%)</td></tr><tr><th align="right">YTD</th><td align="left">' + d.cum + ' (' + formatDecimal(100*d.cum/d.acum) + '%)</td></tr><tr><th align="right">Temp</th><td align="left">' + Temp + '</td></tr><tr><th align="right">Flow</th><td align="left">' + fdata.Flow + ' (' + formatDecimal(100*fdata.Flow/fdata.Mflow) + '%)</td></tr></table>';
	}	
	
	mbars.selectAll("rect")
      .data(data)
	  .enter()
	  .append("rect")
      .attr("width", bwidth2)
	  .attr("x", function(d) { 
		var _x = x(d.Date) - bwidth2/2;
		return(_x);
		})
      .attr("y", 0)
      .attr("height", height)
	  .style("fill-opacity", 0)
	  .style("opacity",0)
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html(mouseOverHTML(d))	
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 14) + "px");
			drawCursor(svg2,d.Date);
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);
			d3.selectAll(".curse").remove();

	  })
	  ;	
	 
	var fbars = svg2.append("g").attr("class", "flows");
	
	fbars.selectAll("rect")
      .data(fdata.filter(function(d){
		return isNaN(d.Flow) | isNaN(d.Mflow) ? false : true;
		}))
	  .enter()
	  .append("rect")
      .attr("width", bwidth)
	  .attr("x", function(d) { 
		var _x = x(d.Date) - bwidth/2;
		//console.log("x = " + _x)	
		return(_x);
		})
      .attr("y", function(d){
	    var offset = 10*d.Flow/(2*d.Mflow)
		if(isNaN(offset))console.log(d);
		var yy = height + 35 - offset;
		return yy;
		})
      .attr("height", function(d){return 10*d.Flow/d.Mflow})
	  .style("fill", function(d) {
			var tcolor = "#bbbbbb";
			if(!isNaN(d.TempC)) tcolor = getTempColor(d.TempC);
			else if(!isNaN(d.TempS))tcolor = getTempColor(d.TempS);
			return tcolor;
	  })
	  	  .on("mouseover", function(d) {
			var temp = "NA";
			if(!isNaN(d.TempC))temp = d.TempC;
			else if(!isNaN(d.TempS))temp = d.TempS;
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html('<table><tr><th>Date</th><td>' + format1(d.Date) + '</td></tr><tr><th>Temp</th><td>' + temp + '</td></tr><tr><th>Flow</th><td>' + d.Flow + '</td></tr><tr><th>Mean</th><td>' + d.Mflow + '</td></tr></table>')	
                .style("left", (d3.event.pageX + 5) + "px")     
                .style("top", (d3.event.pageY +5) + "px");
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);
	  });
	  
	  svg1
	  .append("image")
      .attr("xlink:href", "close_icon.jpg")
      .attr("x", width + margin.left + margin.right-20)
      .attr("y", 0)
      .attr("width", 20)
      .attr("height", 20)
	  .attr("class", "close_button")
	  .style("opacity",1)
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html('Delete This')  
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 10) + "px");    
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);   
		})
	  .on("click", function(d){			
		d3.selectAll("." + id).remove();
		tipdiv.style("opacity", 0);
		});
		
	var tablevars = ["Count","Avg","YTD","AvgYTD","TempS","TempC","Flow","Mflow","Spill"]
	var datadiv = d3.select(target)
		.append("div")
		.attr("class",id)
		.style("display","none")
		//.style("overflow","scroll")
		//.attr("margin-left",200)
	//console.log(flowdata)
	
	//initialize csv data
	var csvrow;
	params.daily.csvdata[id][species].push(["Date","Species","Dam","Count","Avg","YTD","AvgYTD","TempS","TempC","Flow","Mflow","Spill"])
	var datatable = datadiv.append("table").property("border",1).style("margin-left",150)
	var row = datatable.append("tr");
	row.append("th").html("Date")
	row.append("th").html("Species")
	row.append("th").html("Dam")
	tablevars.forEach(function(d){
		row.append("th").html(d)
	})
	
	Object.keys(flowdata).forEach(function(d){
		csvrow = []
		row = datatable.append("tr");
		row.append("td").html(d)
		csvrow.push(d);
		row.append("td").html(species)
		csvrow.push(species);
		row.append("td").html(project)
		csvrow.push(project);
		tablevars.forEach(function(dd){
			row.append("td").html(flowdata[d][dd]);
			csvrow.push(flowdata[d][dd] ? flowdata[d][dd] : "NA")
		})
		params.daily.csvdata[id][species].push(csvrow)
	})
	
	
	
	 svg1
	.append("image")
      .attr("xlink:href", "open_table.jpg")
      .attr("width", 20)
      .attr("height", 20)
      .attr("x", width + margin.left + margin.right-20)
      .attr("y", height + margin.top + margin.bottom-150)
	  .attr("class", "showdata")
	  .style("cursor","pointer")
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html(datadiv.style("display")=="none" ? "Show Table" : "Hide table")  
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 10) + "px");    
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);   
		})
	  .on("click", function(d){			
		if(datadiv.style("display")=="none"){
			datadiv.style("display","block");
			d3.select(this).attr("xlink:href", "close_table.jpg")
		}	
		else {
			datadiv.style("display","none");
			d3.select(this).attr("xlink:href", "open_table.jpg")
		}	
		tipdiv.style("opacity", 0);
		})
	  	
	 svg1
	.append("image")
      .attr("xlink:href", "download.png")
      .attr("width", 20)
      .attr("height", 20)
      .attr("x", width + margin.left + margin.right-20)
      .attr("y", height + margin.top + margin.bottom-124)
	  .attr("class", "download")
	  .style("cursor","pointer")
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html("Download Data")  
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 10) + "px");    
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);   
		})
	  .on("click", function(d){	
			filename = project + "_" + species + "_" + year + ".csv"
			writeCSV(params.daily.csvdata[id][species],filename)
		})
}

var plotLegend = function(target){
	var width = 1000
	var height = 80;
	var margin = {top: 20,bottom: 20}
	var water_position = [100,12];
	
	//create data
	var fdata = [], t, f
	for(i=1;i<101;i++){
		t = i/4
		f = 2 - i*(1.5)/100 
		fdata.push({x: i*2.5, f: f, t: t})
	}
	
	var x = d3.scale.linear().domain([0,25]).range([0, 250]),
		x2 = d3.scale.linear().domain([2,0.5]).range([0, 250]),
		y = d3.scale.linear().domain([3,-3]).range([0, height]),
		bwidth = 4

	var xAxis = d3.svg.axis().scale(x).orient("bottom");
	var xAxis2 = d3.svg.axis().scale(x2).orient("top");
	var yAxis = d3.svg.axis().scale(y).orient("left").ticks(4);	

	var svg = d3.select(target).append("svg")
		.attr("class","legend")
		.attr("width", width)
		.attr("height", height + margin.top + margin.bottom);
		
	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + water_position[0] + "," + (height+margin.bottom-20) + ")")
		.call(xAxis);
		
	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(" + water_position[0] + "," + (margin.top + 20) + ")")
		.call(xAxis2);		

	svg.append("g")
		.attr("transform", "translate(" + (water_position[0] + x2(1.8)) + ",13)")
		.append("text")
		.attr("class","legend_text")
		.text("Flow (relative to 10yr mean)")
		
		svg.append("g")
		.attr("transform", "translate(" + (water_position[0] + x(5)) + "," + (margin.top + height + margin.bottom -3) + ")")
		.append("text")
		.attr("class","legend_text")
		.text("Water Temperature (\xB0C)")	
	
/*	
	var ldata =  [{x:2.2,text:"2x"},{x:8.2,text:"1.5x"},{x:14.2,text:"1x"},{x:21.5,text:".5x"}]	
		
	ldata.forEach(function(d,i){
	svg.append("g")
		.attr("transform", "translate(" + (water_position[0] + x(d.x)) + "," + (water_position[1]+i*2+15) + ")")
		.append("text")
		.attr("class","legend_text")
		.text(function(){
			return d.text
		})		
	})
*/
	d3.selectAll(".legend_text").style("font","14px sans-serif")	

	var fbars = svg.append("g").attr("class", "flows");
	
	fbars.selectAll("rect")
      .data(fdata)
	  .enter()
	  .append("rect")
      .attr("width", bwidth)
	  .attr("x", function(d) { 
		var _x =  100 + d.x - bwidth/2;
		return(_x);
		})
      .attr("y", function(d){
	    var offset = 10*d.f
		if(isNaN(offset))console.log(d);
		var yy = (height + margin.top+margin.bottom)/2 - offset/2;
		return yy;
		})
      .attr("height", function(d){return 10*d.f})
	  .style("fill", function(d) {
			var tcolor = "#bbbbbb";
			tcolor = getTempColor(d.t);
			return tcolor;
	  })
	  	  .on("mouseover", function(d) {
			var temp = d.t
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html('<table><tr><th>Temp</th><td>' + temp + '</td></tr><tr><th>Relative Flow</th><td>' + d.f + '</td></tr></table>')	
                .style("left", (d3.event.pageX + 5) + "px")     
                .style("top", (d3.event.pageY +5) + "px");
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);
	  });
}

	
var plotCounts = function(svg_target,species){
	var margin = {top: 0, right: 50, bottom: 50, left: 150},
		width1 = params.topchart.width - params.topchart.margin.left - params.topchart.margin.right,
		width2 = params.topchart.margin.right - params.topchart.margin.left2 - params.topchart.margin.right2,
		height = params.topchart.height - params.topchart.margin.top - params.topchart.margin.bottom;
	
	var data1 = counts[species];
	var data = [];
	data1.forEach(function(d){
		if(+d.Year >= Current.year_range[0] & d.Year <= Current.year_range[1])data.push(d);
	});
	//console.log(data)
	var svg1 = svg_target.append("svg")
		.attr("class","chosen")
		.attr("width", params.topchart.width)
		.attr("height", params.topchart.height);
		
	var max_counts = 0;
	var maxes = {};
	projects.forEach(function(d){
		maxes[d] = 0
	});
	
	var bar_scale = height/(projects.length+1)*.9;
	var bar_scale2 = height/(projects.length+1);
	var bar_scale3 = bar_scale2 * .7;
	data.forEach(function(d){
		maxes[d.Project] = d.Counts > maxes[d.Project] ? d.Counts : maxes[d.Project];
		max_counts = d.Counts > max_counts ? d.Counts : max_counts;
	});
	
	var dmax = d3.max(params.current[species],function(dd){return dd.Counts/dd.Avg});
	domain = dmax < 1.2 ? [0,1.2] : [0,dmax];
	
	var x = d3.scale.linear().domain(Current.plotted_range).range([0, width1]),
		x2 = d3.scale.linear().domain(domain).range([0, width2]),
		y = d3.scale.ordinal().rangeBands([0, height], 1);
		y.domain(projects);

	var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.format("d"));
	var xAxis2 = d3.svg.axis().scale(x2).orient("bottom").tickFormat(d3.format("d"));
	var yAxis = d3.svg.axis().scale(y).orient("left");
			
	params.topchart.y = y;
			
	var svg2 = svg1.append("g")
			.attr("class", "main")
			.attr("transform", "translate(" + params.topchart.margin.left + "," + params.topchart.margin.top + ")");		
			
	var yaxis = svg2.append("g")
			.attr("class", "y axis")
			.call(yAxis)
			.append("text")
			.attr("transform", "rotate(-90)")
			.attr("class","damname")
			.attr("y", 6)
			.attr("dy", ".71em")
			.style("text-anchor", "end");
			
			
	svg2.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);
		
	d3.selectAll(".main").selectAll(".tick")
	  .on("click", function(d){
			console.log(d)
			plotSingleDam(d);
	  })
	  .on("mouseover", function(d) {
			
        })                  
	  .on("mouseout", function(d) {
		
		})	
	var lineFunction = d3.svg.line()
	.x(function(d) { return d.x; })
	.y(function(d) { return d.y; })
	.interpolate("linear");		
	
	addGrid2 = function(s){
		var lineData = [];
		for(i=0;i<projects.length;i++){
		lineData.push({points:[{x: 0, y: y(projects[i]) + bar_scale/2},{x: width1, y:y(projects[i]) + bar_scale/2}]});
		}	
		var grid = s.append("g").attr("class", "grid");

		grid.selectAll("path")
			.data(lineData)
			.enter()
			.append("path")
			.attr("class", "line")
			.attr("d", function (d) {
				return lineFunction(d.points);
			})
			.style("stroke", function (d) {
			return "#aaaaaa";
			});
	}	
	
	addGrid2(svg2);
	var bars = svg2.append("g").attr("class", "bars");
	

	bars.selectAll("rect")
      .data(data)
	  .enter()
	  .append("rect")
      .attr("width", .75*(x(2000)-x(1999)))
	  .attr("x", function(d) { 
		var _x = x(d.Year) - .375*(x(d.Year+1)-x(d.Year));
		//console.log("x = " + _x)	
		return(_x);
		})
      .attr("y", function(d) {
	    var smax = scale_by_dam ? maxes[d.Project] : max_counts;
		var offset = d.Counts>0 ? bar_scale*(1-d.Counts/smax) : bar_scale; 
		var yy = y(d.Project) - bar_scale/2 + offset;
		//console.log(yy);
		return yy;
	  })
      .attr("height", function(d) {
		var smax = scale_by_dam ? maxes[d.Project] : max_counts;
		var h= d.Counts>0 ? (d.Counts/smax)*bar_scale : 0; 
		return h; })
	  .attr("class",function(d){
		return species_lookup[d.Species]+rproject_lookup[d.Project]+d.Year;
	  })
	  .style("fill", function(d) {
			return "#016986";
	  })
	  .style("stroke","#999999");
	  
	var hbars = svg1.append("g")
		.attr("class", "hbars")
		.attr("transform", "translate(" + (params.topchart.margin.left + width1 + params.topchart.margin.left2) + "," + params.topchart.margin.top + ")");
	
	hbars.selectAll("rect")
      .data(params.current[species])
	  .enter()
	  .append("rect")
      .attr("width", function(d){
		if(d.Avg > 0)return x2(d.Current/d.Avg);
		else return 0;
	  })
	  .attr("x", 0)
      .attr("y", function(d) { 
		var yy = y(d.Project) - bar_scale3/2;
		return yy;
	  })
      .attr("height", bar_scale3)
	  .style("fill", function(d) {
			return "#016986";
	  })
	  .style("stroke","#999999");

	hbars.append("g")
		.attr("class", "x2 axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis2); 

	hbars.append("g")
			.attr("class", "y2 axis")
			.call(yAxis)
	
	hbars.select(".y2").selectAll(".tick").select("text").remove()
	
	var formatDecimal = d3.format(".1f");
	
	if(params.current_value_display < 4){
		hbars.selectAll(".textdisplay")
			.data(params.current[species])
			.enter()
			.append("text")
			.attr("class","textdisplay")
			.attr("x", function(d){
				if(d.Avg > 0)return x2(d.Counts/d.Avg) + 5;
				else return 5;
			})
			.attr("y", function(d) { 
				return y(d.Project)+5;
			})
			.text(function(d){
				if(d.Counts<0) return "NA";
				else{
				switch(params.current_value_display) {
					case 0:
						return d.Counts;
						break;
					case 1:
						return d.Counts + " (" + (d.Avg <=0 ? "NA" : d.Avg) + ")";
						break;
					case 2:
						return d.Counts + " (" + (d.Avg <=0 ? "NA" : formatDecimal(100*d.Counts/d.Avg)) + "%)";
						break;					
					default:
						return d.Avg <=0 ? "NA" : formatDecimal(100*d.Counts/d.Avg) + "%";
				}
				}				
			})
	}
	

	var addAxisLabel = function(target,xpos,ypos,text){
				target.append("g")
				.append("text")
                .attr("class", "x-axis-label")
                .attr("text-anchor", "middle")
                .attr("x", xpos)
                .attr("y", ypos)
                .text(text)
				.style("font-weight","bold");
	}
	
	

	addAxisLabel(svg1,params.topchart.margin.left+(width1/2),params.topchart.height-16,"Counts by Year")
	addAxisLabel(svg1,params.topchart.margin.left+width1+params.topchart.margin.right2+width2/3,params.topchart.height-16,year + " YTD/10yr Avg YTD")
	addAxisLabel(svg1,params.topchart.margin.left+width1+params.topchart.margin.right2+width2/3, params.topchart.height,"(" + params.fdate + ")")		
	var curse;	  

	var drawCursor = function(target,year,pop){
		d3.selectAll(".curse").remove();  
		curse = target.append("g")
		.attr("class","curse")
		.style("z-index", -1)

		curse.append("line")
          .attr({
            "x1": -5,
            "y1": y(pop),
            "x2": 5,
            "y2": y(pop),
			"stroke-width": 4,
			"stroke":"black"
          })
		  .attr("class","line2")
		  ;


		// vertical crosshair
    
		curse.append("line")
          .attr({
            "x1": x(year),
            "y1": 0,
            "x2": x(year),
            "y2": height,
			"stroke-width":1,
			"stroke":"black"			  
            })
	}
	
	
	
	var mouseOverHTML = function(d){
		return '<table width="150" align="right"><tr><th>Dam</th><td>' + d.Project + '</td></tr><tr><th>Year</th><td align="left">'+ d.Year + '</td></tr><tr><th>Count</th><td align="left">' + d.Counts + '</td></tr></table>';
}	
	
	var mouseOverHTML2 = function(d){
		return '<table width="200" align="right"><tr><th>Dam</th><td>' + d.Project + '</td></tr><tr><th>Date</th><td align="left">'+ params.fdate + '</td></tr><tr><th>YTD</th><td align="left">' + d.Counts + '</td></tr><tr><th>10yrAvg</th><td align="left">' + d.Avg + '</td></tr><tr><th></th><td align="left">' + '(' + formatDecimal(100*d.Counts/d.Avg) + '%)' + '</td></tr></table>';
}

	var setMouseOver = function(target){
	  target.selectAll("rect")
      .data(data)
	  .enter().append("rect")
      .attr("width", (x(2000)-x(1999)))
	  .attr("x", function(d) { return x(d.Year) - .5*(x(2000)-x(1999)); })
      .attr("y", function(d) {
	    return y(d.Project) - bar_scale2/2; 
	  })
      .attr("height", function(d) {
		return bar_scale2; })
	  .style("fill-opacity", 0) 
	  .style("opacity", 0)
	  .style("z-index", 5)
	  .on("mouseover", function(d) {
			//d3.select(this).style("fill-opacity", .5);
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html(mouseOverHTML(d))	
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 14) + "px");
			drawCursor(target,d.Year,d.Project);
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);
			d3.selectAll(".curse").remove();
			//setPopTextDecoration(d.Pop,"off");
	  })
	  .on("click", function(d) { 
		d3.select("." + species_lookup[d.Species]+rproject_lookup[d.Project]+d.Year).classed("loaded",true).style("fill","#002833");
		getDailyCounts(rproject_lookup[d.Project],d.Year);
	  })
}

	var setMouseOver2 = function(target){
	  target.selectAll("rect")
      .data(params.current[species])
	  .enter().append("rect")
      .attr("width", function(d){
		if(d.Avg > 0)return x2(d.Current/d.Avg);
		else return 0;
	  })
	  .attr("x", 0)
      .attr("y", function(d) { 
		var yy = y(d.Project) - bar_scale3/2;
		return yy;
	  })
      .attr("height", bar_scale3)
	  .style("fill-opacity", 0) 
	  .style("opacity", 0)
	  .style("z-index", 5)
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html(mouseOverHTML2(d))	
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 14) + "px");
			//drawCursor(target,d.Year,d.Project);
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);
			d3.selectAll(".curse").remove();
			//setPopTextDecoration(d.Pop,"off");
	  })
	  .on("click", function(d) { 
		d3.select("." + species_lookup[d.Species]+rproject_lookup[d.Project]+d.Year).classed("loaded",true).style("fill","#002833");
		getDailyCounts(rproject_lookup[d.Project],d.Year);
	  })
}


setMouseOver(svg2.append("g").attr("class", "mouseover"));
setMouseOver2(hbars.append("g").attr("class", "mouseover"));

var range_selected = [];

var setRangeSelector = function(target){
	var range = target.append("g").attr("class", "range");
	var xdata = [];
	for (var i = Current.year_range[0]; i <= Current.year_range[1]; ++i) xdata.push(i);
	range
	  .selectAll("rect")
	  .data(xdata)
	  .enter()
	  .append("rect")
	  .attr("width",(x(500)-x(499)))
	  .attr("x", function(d) { 
		return x(d) - .5*(x(500)-x(499)); })
      .attr("y", height)
      .attr("height", 25) 
      .style("fill", function(d) { return "gray"; })
	  .style("fill-opacity",0)
	  .attr("class", function(d) {return 'range'+d;})
	  .on("mousedown",function(d){
		dragging = true;
		range_selected.push(d);
	  })
	  .on("mousemove",function(d){
		if(dragging)d3.selectAll(".range" + d).style("fill-opacity",.5);
	  })
	  .on("mouseup",function(d){
	    d3.event.preventDefault();
		dragging=false;
		range_selected.push(d);
		range_selected = range_selected[0]>range_selected[1] ? [range_selected[1],range_selected[0]] : range_selected;
		Current.year_range[0] = range_selected[0];
		Current.year_range[1] = range_selected[1];
		Current.plotted_range[0] = range_selected[0]-1;
		Current.plotted_range[1] = range_selected[1]+1;
		plotAll();
	  })	  
	}	
	setRangeSelector(svg2);
	var dragging=false;
	
	var setYearArrow = function(direction,xpos){
	d3.selectAll(".chosen")
	  .append("image")
      .attr("xlink:href", direction + "_year_arrow.jpg")
      .attr("x", xpos)
      .attr("y", margin.top+height)
      .attr("width", 33)
      .attr("height", 20)
	  .attr("class", "year_button")
	  .style("opacity",1)
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html('Reset')  
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 10) + "px");    
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);   
		})
	  .on("click", function(d){			
			if(direction=="left"){
				Current.year_range[0] = Default.year_range[0];
				Current.plotted_range[0] = Default.plotted_range[0];
			}
			else{
				Current.year_range[1] = Default.year_range[1];
				Current.plotted_range[1] = Default.plotted_range[1];			
			}
			plotAll()
		});

}

if(Current.year_range[0] != Default.year_range[0])setYearArrow('left',margin.left-45);
if(Current.year_range[1] != Default.year_range[1])setYearArrow('right',margin.left+width1+15);

}	

var plotAll = function(){
	d3.selectAll(".chosen").remove();
		plotCounts(d3.select("#chinook_svg"),"Chinook");
		plotCounts(d3.select("#jchinook_svg"),"Jack.Chinook");
		plotCounts(d3.select("#steelhead_svg"),"Steelhead");
		plotCounts(d3.select("#wsteelhead_svg"),"Wild.Steelhead");
		plotCounts(d3.select("#sockeye_svg"),"Sockeye");
		plotCounts(d3.select("#coho_svg"),"Coho");
		plotCounts(d3.select("#jcoho_svg"),"Jack.Coho");
		plotCounts(d3.select("#lamprey_svg"),"Lamprey");
		plotCounts(d3.select("#shad_svg"),"Shad");
		d3.selectAll(".y.axis").selectAll("text").style("font-size","13px");
}



var getDailyCounts = function(project,year){
d3.select("#spinner").style('visibility','visible');
//var url_counts = "http://www.onefishtwofish.net/DartDamCounts.jsp?http://www.cbr.washington.edu/dart/cs/php/rpt/adult_daily.php?sc=1&outputFormat=csv&year=" + year + "&proj=" + project + "&span=no&startdate=1%2F1&enddate=12%2F31&run=&syear=" + year + "&eyear=" + year + "&avg=1"; 
var url_counts = "http://www.cbr.washington.edu/dart/cs/php/rpt/adult_daily.php?sc=1&outputFormat=csv&year=" + year + "&proj=" + project + "&span=no&startdate=1%2F1&enddate=12%2F31&run=&syear=" + year + "&eyear=" + year + "&avg=1"; 
//var year1 = year - 1;
var year1 = 2020; //use 2005-2015 mean flow as reference
//var url_flow = "http://www.onefishtwofish.net/DartDamCounts.jsp?http://www.cbr.washington.edu/dart/cs/php/rpt/mg.php?sc=1&mgconfig=river&outputFormat=csv&year%5B%5D=" + year + "&loc%5B%5D=" + project + "&data%5B%5D=Outflow&data%5B%5D=Outflow+10YrAvg&data%5B%5D=Spill&data%5B%5D=Temp+%28Scroll+Case%29&data%5B%5D=Temp+%28WQM%29&startdate=1%2F1&enddate=12%2F31&avgyear=" + year1 + "&consolidate=1&grid=1&y1min=0&y1max=&y2min=&y2max=&y3min=&y3max=&y4min=&y4max=&size=medium";
var url_flow = "http://www.cbr.washington.edu/dart/cs/php/rpt/mg.php?sc=1&mgconfig=river&outputFormat=csv&year%5B%5D=" + year + "&loc%5B%5D=" + project + "&data%5B%5D=Outflow&data%5B%5D=Outflow+10YrAvg&data%5B%5D=Spill&data%5B%5D=Temp+%28Scroll+Case%29&data%5B%5D=Temp+%28WQM%29&startdate=1%2F1&enddate=12%2F31&avgyear=" + year1 + "&consolidate=1&grid=1&y1min=0&y1max=&y2min=&y2max=&y3min=&y3max=&y4min=&y4max=&size=medium";

d3.xhr(url_flow).get(function (err1, response1) {
  var dirtyCSV1 = response1.responseText;
  var firstEOL1 = dirtyCSV1.indexOf('\n');
  var parsedCSV1 = d3.csv.parse(dirtyCSV1.substring(firstEOL1+2));
d3.xhr(url_counts).get(function (err, response) {
  d3.select("#spinner").style('visibility','hidden');
  var dirtyCSV = response.responseText;
  var firstEOL = dirtyCSV.indexOf('\n');
  //var parsedCSV = d3.csv.parse(dirtyCSV.substring(firstEOL+1));
  var parsedCSV = d3.csv.parse(dirtyCSV);
  plotAllDaily(year, parsedCSV, parsedCSV1);
  //console.log(parsedCSV)
});
});

};

var parseDaily = function(data,d){
	var date = format1.parse(d.Date);
	var temp = d.TempC;
	data["Chinook"].push({Date: date, Species: "Chinook", Project: d.Project, TempC: temp, Counts: +d.Chin, Avg: +d["Chinook 10YearAvg"] });
	if(+d.JChin >0)data["Jack.Chinook"].push({Date: date, Species: "Jack.Chinook", Project: d.Project, TempC: temp, Counts: +d.JChin, Avg: +d["Jack Chinook 10YearAvg"]});
	if(+d.Coho >0)data["Coho"].push({Date: date, Species: "Coho", Project: d.Project, TempC: temp, Counts: +d.Coho, Avg: +d["Coho 10YearAvg"]});
	if(+d.JCoho >0)data["Jack.Coho"].push({Date: date, Species: "Jack.Coho", Project: d.Project, TempC: temp, Counts: +d.JCoho, Avg: ""});
	if(+d.Stlhd >0)data["Steelhead"].push({Date: date, Species:"Steelhead", Project: d.Project, TempC: temp, Counts: +d.Stlhd, Avg: +d["Steelhead 10YearAvg"]});
	if(+d.WStlhd >0)data["Wild.Steelhead"].push({Date: date, Species:"Wild.Steelhead", Project: d.Project, TempC: temp, Counts: +d.WStlhd, Avg: +d["Wild Steelhead 10YearAvg"]});
	if(+d.Sock >0)data["Sockeye"].push({Date: date, Species: "Sockeye", Project: d.Project, TempC: temp, Counts: +d.Sock, Avg: +d["Sockeye 10YearAvg"]});
	if(+d.Shad >0)data["Shad"].push({Date: date, Species: "Shad", Project: d.Project, TempC: temp, Counts: +d.Shad, Avg: +d["Shad 10YearAvg"]});
	if(+d.Lmpry >0)data["Lamprey"].push({Date: date, Species: "Lamprey", Project: d.Project, TempC: temp, Counts: +d.Lmpry, Avg: ""});
	return data;
}

function createTable(target,tableData) {
  var table = document.createElement('table');
  var tableBody = document.createElement('tbody');

  tableData.forEach(function(rowData) {
    var row = document.createElement('tr');

    rowData.forEach(function(cellData) {
      var cell = document.createElement('td');
      cell.appendChild(document.createTextNode(cellData));
      row.appendChild(cell);
    });

    tableBody.appendChild(row);
  });

  table.appendChild(tableBody);
  target.appendChild(table);
}

var plotAllDaily = function(year, _data, _fdata){
	var keys = Object.keys(_fdata[0]);
	//console.log(keys);
	var fdata = [];
	_fdata.forEach(function(d){
		d.Flow = +d[keys[1]];
		d.Mflow = +d[keys[2]];
		for(i=3;i<keys.length;i++){
			if(keys[i].indexOf("spill") != -1)d.Spill = +d[keys[i]];
			if(keys[i].indexOf("tempscr") != -1)d.TempS = +d[keys[i]]>0 ? +d[keys[i]] : NaN;
			if(keys[i].indexOf("tempc") != -1)d.TempC = +d[keys[i]]>0 ? +d[keys[i]] : NaN;
		}
		d.Date = d3.time.format("%Y/%m/%d").parse(year + "/" + d[keys[0]]);
		for(i=0;i<keys.length;i++)delete d[keys[i]];
		if(d.Date)fdata.push(d);
	});
	//console.log(fdata)
	var data = {};
	
	var project = _data[0].Project;
	species.forEach(function(d){data[d] = [];});
	_data.forEach(function(d){
		if (!(d.Date == null)) data = parseDaily(data,d);
	});
	
	var legend = params.daily.id==0 ? true : false;
	
	var id = "ID" + params.daily.id++;
	params.daily.csvdata[id] = {}
	species.forEach(function(d,i){
		if(data[d].length>0){
			var legend_target = "#" + species_lookup[d] + "_legend";
			//if(legend)plotLegend(legend_target)
			if(legend){
				var targ = d3.select(legend_target)
				targ.append("hr")
				targ.append("img").attr("src","Daily_Legend.jpg")
			}
			var target = "#" + species_lookup[d] + "_svg";
			var label = d.replace(".", " ");
			plotDailyCounts(data[d],fdata,target,project,id);
			//showTable(target,data[d])
		}
	});
}

var plotSingleDam = function(project){
	var id = "ID" + params.daily.id++;
	var damdata
	species.forEach(function(d,i){
		damdata = params.data.filter(function(dd){
			return dd.Species == d & dd.Project == project;
		})
		console.log(damdata)
		if(damdata.length>0){
			var target = "#" + species_lookup[d] + "_svg";
			var label = d.replace(".", " ");
			plotSpeciesDam(target,project,damdata,d,id);
			//showTable(target,data[d])
		}
	});
}

var plotSpeciesDam = function(target,project,damdata,species,id){
	
	console.log(project)
	
	var height2 = 200;
	var width2 = 1050;
	var margin = {top: 60, right: 100, bottom: 50, left: 150},
	width = width2 - margin.left - margin.right,
	height = height2 - margin.top - margin.bottom;

	
	var svg1 = d3.select(target).append("svg")
		.attr("class","single")
		.classed(id,true)
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom);
		
	var max_counts = 0;

	damdata.forEach(function(d){max_counts = d.Counts > max_counts ? d.Counts : max_counts})
	
	damdata.sort(function(a,b){
		return a.Year-b.Year;
	});	
	
	var x = d3.scale.linear().domain(Current.plotted_range).range([0, width]),
		y = d3.scale.linear().domain([0, d3.max(damdata, function(d) { return d.Counts; })]).range([height,0]);

	var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.format("d"));
	var yAxis = d3.svg.axis().scale(y).orient("left");

	var svg2 = svg1.append("g")
			.attr("class", "main")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");		
			
	svg2.append("g")
			.attr("class", "y axis")
			.call(yAxis)
			.append("text")
			.attr("transform", "rotate(-90)")
			.attr("y", 6)
			.attr("dy", ".71em")
			.style("text-anchor", "end");
			
	svg2.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);



	var bars = svg2.append("g").attr("class", "bars");
	
	bars.selectAll("rect")
      .data(damdata)
	  .enter()
	  .append("rect")
      .attr("width", .75*(x(2000)-x(1999)))
	  .attr("x", function(d) { 
		var _x = x(d.Year) - .375*(x(d.Year+1)-x(d.Year));
		//console.log("x = " + _x)	
		return(_x);
		})
      .attr("y", function(d) {
		return y(d.Counts);
	  })
      .attr("height", function(d) {
		var h = height - y(d.Counts); 
		return h; })
	  .attr("class",function(d){
		return species_lookup[species]+rproject_lookup[project]+d.Year;
	  })
	  .style("fill", function(d) {
			return "#016986";
	  })
	  .style("stroke","#999999")
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html(mouseOverHTML(d))	
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 14) + "px");
			drawCursor(svg2,d.Year);
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);
			d3.selectAll(".curse").remove();

	  })	  
	   
	if(params.dam_geomean != "none"){
	var mline = svg2.append("g").attr("class", "meanline");
	
	var linedata = damdata.filter(function(d){return d[params.dam_geomean] > 0})
	linedata.sort(function(a,b){return a.Year-b.Year})
	
	var meanLine = d3.svg.line()
	.x(function(d) { return x(d.Year); })
	.y(function(d) { return y(d[params.dam_geomean]); })
	.interpolate("step-after");	
	
	
	mline
		.selectAll("path")
		.data(linedata)
		.enter()
		.append("path")
		.attr("class", "mean")
		.attr("d", function (d) {
			return meanLine(linedata);
		})
		.style("stroke-width", 1)
		.style("fill","none")	
		.style("stroke","black")	
	
}	

	svg2.append('text')
	.attr('x', 10)
	.attr('y', 0)
	.text(species + " at " + project);
	
	var drawCursor = function(target,year){
		d3.selectAll(".curse").remove();  
		curse = target.append("g")
		.attr("class","curse")
		.style("z-index", -1)
		// vertical crosshair
		curse.append("line")
          .attr({
            "x1": x(year),
            "y1": 0,
            "x2": x(year),
            "y2": height + margin.bottom,
			"stroke-width":1,
			"stroke":"black"			  
            })
	}	
	
	//overlays for mouseover
	var mouseOverHTML = function(d){
		var formatDecimal = d3.format(".1f");

		var html = '<table width="150" cellpadding="3">'
		html += '<tr><th align="right">Year</th><td align="left">'+ d.Year + '</td></tr>'
		html += '<tr><th align="right">Count</th><td align="left">' + d.Counts + '</td></tr>'
		if(params.dam_geomean != "none")html += '<tr><th align="right">' + params.dam_geomean + '</th><td align="left">' + d[params.dam_geomean] + '</td></tr>'
		html += '<tr></tr></table>';
		return html
	}	
	 	  
	  svg1
	  .append("image")
      .attr("xlink:href", "close_icon.jpg")
      .attr("x", width + margin.left + margin.right-20)
      .attr("y", 0)
      .attr("width", 20)
      .attr("height", 20)
	  .attr("class", "close_button")
	  .style("opacity",1)
	  .on("mouseover", function(d) {
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 1);      
            tipdiv.html('Delete This')  
                .style("left", (d3.event.pageX + 20) + "px")     
                .style("top", (d3.event.pageY - 10) + "px");    
        })                  
	  .on("mouseout", function(d) {       
            tipdiv.transition()        
                .duration(20)      
                .style("opacity", 0);   
		})
	  .on("click", function(d){			
		d3.selectAll("." + id).remove();
		tipdiv.style("opacity", 0);
		});
		


	
}

var showTable = function(target,data){
	var t = d3.select(target).append("div")
	//createTable(t.node(),data)
	console.log(data)
}

var getCurrentYearCounts = function(d){
	var species = d.Species.replace("."," ")
	var value = params.ydata[species][d.Project].current;
	return +value;
}

var parseCurrentYear = function(ydata){
	params.ydata={};
	ydata.forEach(function(d){
		if (typeof d.Species != 'undefined'){
			var species = d.Species.replace(" 10YearAvg","")
			if(!params.ydata[species])params.ydata[species]={};
			if(d.Year != ""){
				projects.forEach(function(dam){
					if(d[dam]){
						if(!params.ydata[species][dam])params.ydata[species][dam]= {current: 0}
						params.ydata[species][dam].current = d[dam];
					}
				});
			}			
		}
	});

}

var plotCurrentYear = function(target,species){
	target.selectAll("svg").remove();
	var svg = target.append("svg")
}

var plotAllCurrent = function(){
		plotCurrentYear(d3.select("#chinook_svg2"),"Chinook");
		/*
		plotCurrentYear(d3.select("#jchinook_svg"),"Jack Chinook");
		plotCurrentYear(d3.select("#steelhead_svg"),"Steelhead");
		plotCurrentYear(d3.select("#wsteelhead_svg"),"Wild Steelhead");
		plotCurrentYear(d3.select("#sockeye_svg"),"Sockeye");
		plotCurrentYear(d3.select("#coho_svg"),"Coho");
		plotCurrentYear(d3.select("#jcoho_svg"),"Jack Coho");
		plotCurrentYear(d3.select("#lamprey_svg"),"Lamprey");
		plotCurrentYear(d3.select("#shad_svg"),"Shad");
		*/
		d3.selectAll(".y.axis").selectAll("text").style("font-size","13px");
}

Date.prototype.isLeapYear = function() {
    var year = this.getFullYear();
    if((year & 3) != 0) return false;
    return ((year % 100) != 0 || (year % 400) == 0);
};

// Get Day of Year
Date.prototype.getDOY = function() {
    var dayCount = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    var mn = this.getMonth();
    var dn = this.getDate();
    var dayOfYear = dayCount[mn] + dn;
    if(mn > 1 && this.isLeapYear()) dayOfYear++;
    return dayOfYear;
};
 

Default = {};
Default.plotted_range = [1936,2021];
Current = {};
Default.year_range = [1936,1936];
Current.plotted_range = [Default.plotted_range[0],Default.plotted_range[1]];


var now = new Date();
var year = now.getFullYear()//2018;
var doy = now.getDOY();//364
var historic_url = "DamCounts_05-04-2021.csv"
var current_url = "http://www.cbr.washington.edu/dart/cs/php/rpt/adult_basin_sum.php?sc=1&outputFormat=csv&year=" + year;
//var current_url = "http://www.onefishtwofish.net/DartDamCounts.jsp?http://www.cbr.washington.edu/dart/cs/php/rpt/adult_basin_sum.php?sc=1&outputFormat=csv&year=" + year;
var mean_url = "10YrMeans/10YrMeanDay" + doy + ".csv";

var formatDate = d3.time.format("%m-%d-%Y")
params.date = now;
params.fdate = formatDate(now);
params.doy = doy;
params.year = year;
params.formatDate = formatDate;

d3.xhr(current_url).get(function (err, response) {
	
	var dirtyCSV = response.responseText;
	//params.debug = response.responseText;
	var firstEOL = dirtyCSV.indexOf('\n');
	parseCurrentYear(d3.csv.parse(dirtyCSV));
	d3.csv(historic_url, function (data) {
	d3.csv(mean_url, function (meandata) {
	
	params.data=data
	params.current = {}
	params.maxavg = {}
	
	meandata.forEach(function(d){
		Object.keys(d).forEach(function(spec){
			if(spec != "Project"){
				//if(!params.maxavg[spec])params.maxavg[spec]={};
				//if(!params.maxavg[spec][d.Project])params.maxavg[spec][d.Project]=0;
				//if(+d[spec]>params.maxavg[spec][d.Project])params.maxavg[spec][d.Project]=+d[spec];
				var species = spec.replace("."," ");
				if(!params.current[spec])params.current[spec] = []
				params.current[spec].push({Project: d.Project, Current: +params.ydata[species][d.Project].current, Counts: +params.ydata[species][d.Project].current, Avg: +d[spec], Year: year})
			}
		})
	})
	
	data.forEach(function(d){
			d.Counts = d.Year==year ? getCurrentYearCounts(d) : +d.Counts;
			d["5yrGeomean"] = +d["5yrGeomean"]
			d["10yrGeomean"] = +d["10yrGeomean"]
			d.Year = +d.Year;
			counts[d.Species].push(d);
			Default.year_range[0] = d.Year<Default.year_range[0] ? d.Year : Default.year_range[0];
			Default.year_range[1] = d.Year>Default.year_range[1] ? d.Year : Default.year_range[1];
	});
	
	Current.year_range = [Default.year_range[0],Default.year_range[1]];
/*	
	params.ytd = {}
	
	ytddata.forEach(function(d){
		d.ytd2017 = +d.ytd2017;
		d.ytd2016 = +d.ytd2016;
		d.ytd4yr = +d.ytd4yr;
		d.ytd10yr = +d.ytd10yr;
		d.total10yr = +d.total10yr;
		d.Project = d.dam;
		var sname = d.species.replace(" ",".")
		if(!params.ytd[sname])params.ytd[sname] = [];
		params.ytd[sname].push(d)
	});
*/		
	plotAll();
	d3.select("#spinner").style("visibility",'hidden');
});
});
});
</script>
<script>
$(".checkbox-dropdown").click(function () {
    $(this).toggleClass("is-active");
});

$(".checkbox-dropdown ul").click(function(e) {
    e.stopPropagation();
});

$(".checkbox-dropdown2").click(function () {
	console.log("yo")
    $(this).toggleClass("is-active");
});

$(".checkbox-dropdown2 ul").click(function(e) {
    e.stopPropagation();
});

var writeCSV = function(datarows, filename){
//from https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
//const rows = [["name1", "city1", "some other info"], ["name2", "city2", "more info"]];
let csvContent = "data:text/csv;charset=utf-8,";
datarows.forEach(function(rowArray){
   let row = rowArray.join(",");
   csvContent += row + "\r\n";
});

var encodedUri = encodeURI(csvContent);
var link = document.createElement("a");
link.setAttribute("href", encodedUri);
link.setAttribute("download", filename);
document.body.appendChild(link); // Required for FF

link.click(); // This will download the data file named "my_data.csv".

}
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18774702-1', 'auto');
  ga('send', 'pageview');

</script>
</html>